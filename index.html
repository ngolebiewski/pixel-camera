<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pixel Art Scanner ‚Äì Classroom Edition</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0e0e11;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 12px;
    }
    video, canvas {
      max-width: 90vw;
      border-radius: 8px;
      border: 2px solid #333;
    }
    button, select {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h2>üì∏ Pixel Art Scanner</h2>
  <button id="startCam">‚ñ∂Ô∏è Start Camera</button>

  <video id="video" autoplay playsinline></video>
  <canvas id="overlay" width="512" height="512"></canvas>
  <canvas id="capture" width="512" height="512" hidden></canvas>
  <canvas id="sprite" width="16" height="16"></canvas>

  <div class="row">
    <select id="palette">
      <option value="none">Original Colors</option>
      <option value="nes">NES</option>
      <option value="gb">Game Boy</option>
    </select>
    <button id="snap">Scan</button>
    <button id="save">Save PNG</button>
    <button id="export">Export JSON</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const capture = document.getElementById('capture');
    const sprite = document.getElementById('sprite');
    const paletteSelect = document.getElementById('palette');

    const octx = overlay.getContext('2d');
    const cctx = capture.getContext('2d');
    const sctx = sprite.getContext('2d');

    // Camera will be started via user gesture (required by Firefox/iOS)
   async function startCamera() {
  if (video.srcObject) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    video.srcObject = stream;
  } catch (err) {
    alert(`Camera error:
${err.name}
${err.message}`);
  }
}

document.getElementById('startCam').onclick = startCamera;


    /* ===== LIVE GRID OVERLAY ===== */
    function drawGrid() {
      octx.clearRect(0, 0, overlay.width, overlay.height);
      octx.strokeStyle = 'rgba(0,255,255,0.6)';
      for (let i = 0; i <= 16; i++) {
        let p = i * overlay.width / 16;
        octx.beginPath(); octx.moveTo(p, 0); octx.lineTo(p, overlay.height); octx.stroke();
        octx.beginPath(); octx.moveTo(0, p); octx.lineTo(overlay.width, p); octx.stroke();
      }
      requestAnimationFrame(drawGrid);
    }
    drawGrid();

    /* ===== PALETTES ===== */
    const PALETTES = {
      nes: [
        [124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],
        [168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],
        [0,64,88],[0,0,0]
      ],
      gb: [
        [15,56,15],[48,98,48],[139,172,15],[155,188,15]
      ]
    };

    function nearestPaletteColor(r,g,b,palette) {
      let best, bestD = Infinity;
      for (const [pr,pg,pb] of palette) {
        let d = (r-pr)**2 + (g-pg)**2 + (b-pb)**2;
        if (d < bestD) { bestD = d; best = [pr,pg,pb]; }
      }
      return best;
    }

    /* ===== CONNECTED COMPONENT (EYES) ===== */
    function hasDarkComponent(data, w, h) {
      const visited = new Uint8Array(w*h);
      const idx = (x,y)=>y*w+x;

      for (let y=0;y<h;y++) for (let x=0;x<w;x++){
        const i = idx(x,y);
        if (visited[i]) continue;
        const off = i*4;
        if (data[off]<80 && data[off+1]<80 && data[off+2]<80) {
          let stack=[[x,y]], size=0;
          while(stack.length){
            let [cx,cy]=stack.pop();
            let ci=idx(cx,cy);
            if(visited[ci])continue;
            visited[ci]=1; size++;
            [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
              let nx=cx+dx, ny=cy+dy;
              if(nx>=0&&ny>=0&&nx<w&&ny<h) stack.push([nx,ny]);
            });
          }
          if(size>10) return true;
        }
      }
      return false;
    }

    /* ===== SCAN ===== */
    document.getElementById('startCam').onclick = startCamera;

    document.getElementById('snap').onclick = () => {
      cctx.drawImage(video,0,0,capture.width,capture.height);
      const cw = capture.width/16;
      const ch = capture.height/16;
      sctx.clearRect(0,0,16,16);

      let json = [];

      for(let y=0;y<16;y++){
        let row=[];
        for(let x=0;x<16;x++){
          const img = cctx.getImageData(x*cw,y*ch,cw,ch);
          let r=0,g=0,b=0,c=0;
          for(let i=0;i<img.data.length;i+=4){
            r+=img.data[i]; g+=img.data[i+1]; b+=img.data[i+2]; c++;
          }
          r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);

          let transparent = r>240&&g>240&&b>240 && !hasDarkComponent(img.data,cw,ch);

          if(!transparent){
            if(PALETTES[paletteSelect.value]){
              [r,g,b]=nearestPaletteColor(r,g,b,PALETTES[paletteSelect.value]);
            }
            sctx.fillStyle=`rgb(${r},${g},${b})`;
            sctx.fillRect(x,y,1,1);
            row.push([r,g,b]);
          } else row.push(null);
        }
        json.push(row);
      }
      sprite.dataset.json = JSON.stringify(json);
      sctx.imageSmoothingEnabled=false;
      sprite.style.width='256px'; sprite.style.height='256px';
    };

    /* ===== EXPORT ===== */
    let spriteCount = Number(localStorage.getItem('spriteCount') || 1);

    document.getElementById('save').onclick = () => {
      const filename = `sprite_${String(spriteCount).padStart(3, '0')}.png`;
      spriteCount++;
      localStorage.setItem('spriteCount', spriteCount);

      sprite.toBlob(b => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      });
    };

    document.getElementById('export').onclick=()=>{
      const blob=new Blob([sprite.dataset.json],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='sprite.json'; a.click();
    };
  </script>
</body>
</html>
