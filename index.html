<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Art Scanner</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    margin: 20px;
  }
  #camera-container {
    position: relative;
    display: inline-block;
  }
  video, canvas {
    width: 200px;
    height: 200px;
    border: 1px solid #ccc;
  }
  canvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none; /* grid overlay does not block clicks */
  }
  button {
    margin: 5px;
    font-size: 16px;
  }
</style>
</head>
<body>

<h2>üì∏ Pixel Art Scanner</h2>
<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="grid" width="200" height="200"></canvas>
</div>
<br>
<button id="startCam">‚ñ∂Ô∏è Start Camera</button>
<button id="snap">üì∑ Capture Sprite</button>

<script>
const video = document.getElementById('video');
const gridCanvas = document.getElementById('grid');
const gctx = gridCanvas.getContext('2d');

// Draw 16x16 overlay grid
function drawGrid() {
  const size = 16;
  const w = gridCanvas.width;
  const h = gridCanvas.height;
  gctx.clearRect(0, 0, w, h);
  gctx.strokeStyle = 'rgba(255,255,255,0.5)';
  gctx.lineWidth = 1;

  for(let i=1; i<size; i++){
    const x = (w/size)*i;
    const y = (h/size)*i;
    gctx.beginPath();
    gctx.moveTo(x,0);
    gctx.lineTo(x,h);
    gctx.stroke();
    gctx.beginPath();
    gctx.moveTo(0,y);
    gctx.lineTo(w,y);
    gctx.stroke();
  }
}
drawGrid();

// Start camera on button tap (required by Safari/Firefox)
async function startCamera() {
  if (video.srcObject) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    video.srcObject = stream;
  } catch (err) {
    alert(`Camera error:\n${err.name}\n${err.message}`);
  }
}
document.getElementById('startCam').onclick = startCamera;

// Capture sprite
let spriteCount = Number(localStorage.getItem('spriteCount') || 1);

document.getElementById('snap').onclick = () => {
  const spriteCanvas = document.createElement('canvas');
  spriteCanvas.width = 16;
  spriteCanvas.height = 16;
  const ctx = spriteCanvas.getContext('2d');
  ctx.imageSmoothingEnabled = false; // pixel perfect

  // Draw current video to 16x16 canvas
  ctx.drawImage(video, 0, 0, 16, 16);

  // Optional: make white pixels transparent
  const imgData = ctx.getImageData(0, 0, 16, 16);
  const data = imgData.data;
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];
    // skip eyes if you want
    if (r > 240 && g > 240 && b > 240) {
      data[i+3] = 0; // transparent
    }
  }
  ctx.putImageData(imgData, 0, 0);

  // Auto-increment filename
  const filename = `sprite_${String(spriteCount).padStart(3, '0')}.png`;
  spriteCount++;
  localStorage.setItem('spriteCount', spriteCount);

  spriteCanvas.toBlob(b => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  });
};
</script>

</body>
</html>
